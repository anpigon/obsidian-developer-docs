ë°ì½”ë ˆì´ì…˜(Decorations)ì„ ì‚¬ìš©í•˜ë©´ [[Editor extensions|ì—ë””í„° í™•ì¥ ê¸°ëŠ¥]]ì—ì„œ ì½˜í…ì¸ ë¥¼ ì–´ë–»ê²Œ ê·¸ë¦¬ê±°ë‚˜ ìŠ¤íƒ€ì¼ë§í• ì§€ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—ë””í„°ì—ì„œ ìš”ì†Œë¥¼ ì¶”ê°€, êµì²´í•˜ê±°ë‚˜ ìŠ¤íƒ€ì¼ì„ ë³€ê²½í•˜ì—¬ ëª¨ì–‘ê³¼ ëŠë‚Œì„ ë°”ê¾¸ë ¤ë©´ ëŒ€ë¶€ë¶„ ë°ì½”ë ˆì´ì…˜ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

ì´ í˜ì´ì§€ë¥¼ ì½ê³  ë‚˜ë©´ ë‹¤ìŒì„ í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤:
- ì—ë””í„° ì™¸ê´€ì„ ë³€ê²½í•˜ê¸° ìœ„í•´ ë°ì½”ë ˆì´ì…˜ì„ ì‚¬ìš©í•˜ëŠ” ë°©ë²• ì´í•´
- ìƒíƒœ í•„ë“œì™€ ë·° í”ŒëŸ¬ê·¸ì¸ì„ ì‚¬ìš©í•˜ì—¬ ë°ì½”ë ˆì´ì…˜ì„ ì œê³µí•˜ëŠ” ì°¨ì´ì  ì´í•´

> [!note]
> ì´ í˜ì´ì§€ëŠ” Obsidian í”ŒëŸ¬ê·¸ì¸ ê°œë°œìë¥¼ ìœ„í•´ ê³µì‹ CodeMirror 6 ë¬¸ì„œë¥¼ ìš”ì•½í•œ ê²ƒì…ë‹ˆë‹¤. ìƒíƒœ í•„ë“œì— ëŒ€í•œ ë” ìì„¸í•œ ì •ë³´ëŠ” [Decorating the Document](https://codemirror.net/docs/guide/#decorating-the-document)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.

## í•„ìˆ˜ ì¡°ê±´
- [[State fields]] ê¸°ë³¸ ì´í•´
- [[View plugins]] ê¸°ë³¸ ì´í•´

## ê°œìš”
ë°ì½”ë ˆì´ì…˜ ì—†ì´ëŠ” ë¬¸ì„œê°€ ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œ ë Œë”ë§ë©ë‹ˆë‹¤. ì „í˜€ í¥ë¯¸ë¡­ì§€ ì•Šì£ . ë°ì½”ë ˆì´ì…˜ì„ ì‚¬ìš©í•˜ë©´ í…ìŠ¤íŠ¸ ê°•ì¡°ë‚˜ ì»¤ìŠ¤í…€ HTML ìš”ì†Œ ì¶”ê°€ì™€ ê°™ì´ ë¬¸ì„œ í‘œì‹œ ë°©ì‹ì„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë‹¤ìŒ ìœ í˜•ì˜ ë°ì½”ë ˆì´ì…˜ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
- [ë§ˆí¬ ë°ì½”ë ˆì´ì…˜](https://codemirror.net/docs/ref/#view.Decoration%5Emark): ê¸°ì¡´ ìš”ì†Œ ìŠ¤íƒ€ì¼ë§
- [ìœ„ì ¯ ë°ì½”ë ˆì´ì…˜](https://codemirror.net/docs/ref/#view.Decoration%5Ewidget): ë¬¸ì„œì— ìš”ì†Œ ì‚½ì…
- [êµì²´ ë°ì½”ë ˆì´ì…˜](https://codemirror.net/docs/ref/#view.Decoration%5Ereplace): ë¬¸ì„œ ì¼ë¶€ë¥¼ ë‹¤ë¥¸ ìš”ì†Œë¡œ ìˆ¨ê¸°ê±°ë‚˜ êµì²´
- [ë¼ì¸ ë°ì½”ë ˆì´ì…˜](https://codemirror.net/docs/ref/#view.Decoration%5Eline): ë¬¸ì„œ ìì²´ê°€ ì•„ë‹Œ ë¼ì¸ì— ìŠ¤íƒ€ì¼ ì¶”ê°€

ë°ì½”ë ˆì´ì…˜ì„ ì‚¬ìš©í•˜ë ¤ë©´ ì—ë””í„° í™•ì¥ ê¸°ëŠ¥ ë‚´ë¶€ì—ì„œ ë°ì½”ë ˆì´ì…˜ì„ ìƒì„±í•˜ê³  í™•ì¥ ê¸°ëŠ¥ì´ ì´ë¥¼ ì—ë””í„°ì— _ì œê³µ_í•˜ë„ë¡ í•´ì•¼ í•©ë‹ˆë‹¤. ë°ì½”ë ˆì´ì…˜ì„ ì—ë””í„°ì— ì œê³µí•˜ëŠ” ë°©ë²•ì€ ë‘ ê°€ì§€ì…ë‹ˆë‹¤: [[State fields|ìƒíƒœ í•„ë“œ]]ë¥¼ ì‚¬ìš©í•´ _ì§ì ‘_ ì œê³µí•˜ê±°ë‚˜ [[View plugins|ë·° í”ŒëŸ¬ê·¸ì¸]]ì„ ì‚¬ìš©í•´ _ê°„ì ‘ì ìœ¼ë¡œ_ ì œê³µí•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.

## ë·° í”ŒëŸ¬ê·¸ì¸ê³¼ ìƒíƒœ í•„ë“œ ì¤‘ ì–´ë–¤ ê²ƒì„ ì‚¬ìš©í•´ì•¼ í•˜ë‚˜ìš”?
ë·° í”ŒëŸ¬ê·¸ì¸ê³¼ ìƒíƒœ í•„ë“œ ëª¨ë‘ ë°ì½”ë ˆì´ì…˜ì„ ì œê³µí•  ìˆ˜ ìˆì§€ë§Œ ëª‡ ê°€ì§€ ì°¨ì´ì ì´ ìˆìŠµë‹ˆë‹¤.

- [[Viewport]] ë‚´ë¶€ì— ìˆëŠ” ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ë°ì½”ë ˆì´ì…˜ì„ ê²°ì •í•  ìˆ˜ ìˆë‹¤ë©´ ë·° í”ŒëŸ¬ê·¸ì¸ì„ ì‚¬ìš©í•˜ì„¸ìš”.
- ë·°í¬íŠ¸ ì™¸ë¶€ì˜ ë°ì½”ë ˆì´ì…˜ì„ ê´€ë¦¬í•´ì•¼ í•œë‹¤ë©´ ìƒíƒœ í•„ë“œë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
- ì¤„ ë°”ê¿ˆ ì¶”ê°€ì™€ ê°™ì´ ë·°í¬íŠ¸ ë‚´ìš©ì„ ë³€ê²½í•  ìˆ˜ ìˆëŠ” ë³€ê²½ì„ ì›í•œë‹¤ë©´ ìƒíƒœ í•„ë“œë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.

ë‘ ì ‘ê·¼ ë°©ì‹ ì¤‘ ì–´ëŠ ê²ƒìœ¼ë¡œë„ í™•ì¥ ê¸°ëŠ¥ì„ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤ë©´ ì¼ë°˜ì ìœ¼ë¡œ ë·° í”ŒëŸ¬ê·¸ì¸ì´ ë” ë‚˜ì€ ì„±ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ë¬¸ì„œì˜ ë§ì¶¤ë²•ì„ ê²€ì‚¬í•˜ëŠ” ì—ë””í„° í™•ì¥ ê¸°ëŠ¥ì„ êµ¬í˜„í•œë‹¤ê³  ê°€ì •í•´ ë³´ê² ìŠµë‹ˆë‹¤.

í•œ ê°€ì§€ ë°©ë²•ì€ ì „ì²´ ë¬¸ì„œë¥¼ ì™¸ë¶€ ë§ì¶¤ë²• ê²€ì‚¬ê¸°ì— ì „ë‹¬í•œ ë‹¤ìŒ ë§ì¶¤ë²• ì˜¤ë¥˜ ëª©ë¡ì„ ë°˜í™˜ë°›ëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ ê²½ìš° ê° ì˜¤ë¥˜ë¥¼ ë°ì½”ë ˆì´ì…˜ì— ë§¤í•‘í•˜ê³  í˜„ì¬ ë·°í¬íŠ¸ì— ë¬´ì—‡ì´ ìˆëŠ”ì§€ì™€ ê´€ê³„ì—†ì´ ë°ì½”ë ˆì´ì…˜ì„ ê´€ë¦¬í•˜ê¸° ìœ„í•´ ìƒíƒœ í•„ë“œë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

ë‹¤ë¥¸ ë°©ë²•ì€ ë·°í¬íŠ¸ì— ë³´ì´ëŠ” ë‚´ìš©ë§Œ ë§ì¶¤ë²• ê²€ì‚¬ë¥¼ í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. í™•ì¥ ê¸°ëŠ¥ì€ ì‚¬ìš©ìê°€ ë¬¸ì„œë¥¼ ìŠ¤í¬ë¡¤í•  ë•Œ ì§€ì†ì ìœ¼ë¡œ ë§ì¶¤ë²• ê²€ì‚¬ë¥¼ ì‹¤í–‰í•´ì•¼ í•˜ì§€ë§Œ ìˆ˜ë°±ë§Œ ì¤„ì˜ í…ìŠ¤íŠ¸ê°€ ìˆëŠ” ë¬¸ì„œë„ ë§ì¶¤ë²• ê²€ì‚¬ë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![ìƒíƒœ í•„ë“œ vs ë·° í”ŒëŸ¬ê·¸ì¸](decorations.svg)

## ë°ì½”ë ˆì´ì…˜ ì œê³µ
ë¶ˆë¦¿ ë¦¬ìŠ¤íŠ¸ í•­ëª©ì„ ì´ëª¨ì§€ë¡œ ë°”ê¾¸ëŠ” ì—ë””í„° í™•ì¥ ê¸°ëŠ¥ì„ ë§Œë“¤ê³  ì‹¶ë‹¤ê³  ê°€ì •í•´ ë³´ê² ìŠµë‹ˆë‹¤. ë·° í”ŒëŸ¬ê·¸ì¸ì´ë‚˜ ìƒíƒœ í•„ë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë¥¼ êµ¬í˜„í•  ìˆ˜ ìˆìœ¼ë©° ê°ê° ì•½ê°„ì˜ ì°¨ì´ê°€ ìˆìŠµë‹ˆë‹¤. ì´ ì„¹ì…˜ì—ì„œëŠ” ë‘ ìœ í˜•ì˜ í™•ì¥ ê¸°ëŠ¥ìœ¼ë¡œ êµ¬í˜„í•˜ëŠ” ë°©ë²•ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

ë‘ êµ¬í˜„ ëª¨ë‘ ë™ì¼í•œ í•µì‹¬ ë¡œì§ì„ ê³µìœ í•©ë‹ˆë‹¤:
1. [syntaxTree](https://codemirror.net/docs/ref/#language.syntaxTree)ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¦¬ìŠ¤íŠ¸ í•­ëª© ì°¾ê¸°
2. ê° ë¦¬ìŠ¤íŠ¸ í•­ëª©ì— ëŒ€í•´ ì„ í–‰ í•˜ì´í”ˆ `-`ì„ _ìœ„ì ¯_ìœ¼ë¡œ êµì²´

### ìœ„ì ¯
ìœ„ì ¯ì€ ì—ë””í„°ì— ì¶”ê°€í•  ìˆ˜ ìˆëŠ” ì»¤ìŠ¤í…€ HTML ìš”ì†Œì…ë‹ˆë‹¤. ë¬¸ì„œì˜ íŠ¹ì • ìœ„ì¹˜ì— ìœ„ì ¯ì„ ì‚½ì…í•˜ê±°ë‚˜ ì½˜í…ì¸  ì¼ë¶€ë¥¼ ìœ„ì ¯ìœ¼ë¡œ êµì²´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë‹¤ìŒ ì˜ˆì œëŠ” HTML ìš”ì†Œ `<span>ğŸ‘‰</span>`ì„ ë°˜í™˜í•˜ëŠ” ìœ„ì ¯ì„ ì •ì˜í•©ë‹ˆë‹¤. ë‚˜ì¤‘ì— ì´ ìœ„ì ¯ì„ ì‚¬ìš©í•˜ê²Œ ë©ë‹ˆë‹¤.

```ts
import { EditorView, WidgetType } from '@codemirror/view';

export class EmojiWidget extends WidgetType {
  toDOM(view: EditorView): HTMLElement {
    const div = document.createElement('span');

    div.innerText = 'ğŸ‘‰';

    return div;
  }
}
```

ë¬¸ì„œì˜ ì½˜í…ì¸  ë²”ìœ„ë¥¼ ì´ëª¨ì§€ ìœ„ì ¯ìœ¼ë¡œ êµì²´í•˜ë ¤ë©´ [êµì²´ ë°ì½”ë ˆì´ì…˜](https://codemirror.net/docs/ref/#view.Decoration%5Ereplace)ì„ ì‚¬ìš©í•˜ì„¸ìš”.

```ts
const decoration = Decoration.replace({
  widget: new EmojiWidget()
});
```

### ìƒíƒœ í•„ë“œ
ìƒíƒœ í•„ë“œì—ì„œ ë°ì½”ë ˆì´ì…˜ì„ ì œê³µí•˜ë ¤ë©´:
1. `DecorationSet` íƒ€ì…ìœ¼ë¡œ [[State fields#Defining a state field|ìƒíƒœ í•„ë“œ ì •ì˜]]
2. ìƒíƒœ í•„ë“œì— `provide` ì†ì„± ì¶”ê°€

   ```ts
   provide(field: StateField<DecorationSet>): Extension {
     return EditorView.decorations.from(field);
   },
   ```

```ts
import { syntaxTree } from '@codemirror/language';
import {
  Extension,
  RangeSetBuilder,
  StateField,
  Transaction,
} from '@codemirror/state';
import {
  Decoration,
  DecorationSet,
  EditorView,
  WidgetType,
} from '@codemirror/view';
import { EmojiWidget } from 'emoji';

export const emojiListField = StateField.define<DecorationSet>({
  create(state): DecorationSet {
    return Decoration.none;
  },
  update(oldState: DecorationSet, transaction: Transaction): DecorationSet {
    const builder = new RangeSetBuilder<Decoration>();

    syntaxTree(transaction.state).iterate({
      enter(node) {
        if (node.type.name.startsWith('list')) {
          // '-' ë˜ëŠ” '*'ì˜ ìœ„ì¹˜
          const listCharFrom = node.from - 2;

          builder.add(
            listCharFrom,
            listCharFrom + 1,
            Decoration.replace({
              widget: new EmojiWidget(),
            })
          );
        }
      },
    });

    return builder.finish();
  },
  provide(field: StateField<DecorationSet>): Extension {
    return EditorView.decorations.from(field);
  },
});
```

### ë·° í”ŒëŸ¬ê·¸ì¸
ë·° í”ŒëŸ¬ê·¸ì¸ì„ ì‚¬ìš©í•˜ì—¬ ë°ì½”ë ˆì´ì…˜ì„ ê´€ë¦¬í•˜ë ¤ë©´:
1. [[View plugins#Creating a view plugin|ë·° í”ŒëŸ¬ê·¸ì¸ ìƒì„±]]
2. í”ŒëŸ¬ê·¸ì¸ì— `DecorationSet` ë©¤ë²„ ì†ì„± ì¶”ê°€
3. `constructor()`ì—ì„œ ë°ì½”ë ˆì´ì…˜ ì´ˆê¸°í™”
4. `update()`ì—ì„œ ë°ì½”ë ˆì´ì…˜ ì¬êµ¬ì„±

ëª¨ë“  ì—…ë°ì´íŠ¸ê°€ ë°ì½”ë ˆì´ì…˜ ì¬êµ¬ì„±ì˜ ì´ìœ ëŠ” ì•„ë‹™ë‹ˆë‹¤. ë‹¤ìŒ ì˜ˆì œëŠ” ê¸°ë³¸ ë¬¸ì„œë‚˜ ë·°í¬íŠ¸ê°€ ë³€ê²½ë  ë•Œë§Œ ë°ì½”ë ˆì´ì…˜ì„ ì¬êµ¬ì„±í•©ë‹ˆë‹¤.

```ts
import { syntaxTree } from '@codemirror/language';
import { RangeSetBuilder } from '@codemirror/state';
import {
  Decoration,
  DecorationSet,
  EditorView,
  PluginSpec,
  PluginValue,
  ViewPlugin,
  ViewUpdate,
  WidgetType,
} from '@codemirror/view';
import { EmojiWidget } from 'emoji';

class EmojiListPlugin implements PluginValue {
  decorations: DecorationSet;

  constructor(view: EditorView) {
    this.decorations = this.buildDecorations(view);
  }

  update(update: ViewUpdate) {
    if (update.docChanged || update.viewportChanged) {
      this.decorations = this.buildDecorations(update.view);
    }
  }

  destroy() {}

  buildDecorations(view: EditorView): DecorationSet {
    const builder = new RangeSetBuilder<Decoration>();

    for (let { from, to } of view.visibleRanges) {
      syntaxTree(view.state).iterate({
        from,
        to,
        enter(node) {
          if (node.type.name.startsWith('list')) {
            // '-' ë˜ëŠ” '*'ì˜ ìœ„ì¹˜
            const listCharFrom = node.from - 2;

            builder.add(
              listCharFrom,
              listCharFrom + 1,
              Decoration.replace({
                widget: new EmojiWidget(),
              })
            );
          }
        },
      });
    }

    return builder.finish();
  }
}

const pluginSpec: PluginSpec<EmojiListPlugin> = {
  decorations: (value: EmojiListPlugin) => value.decorations,
};

export const emojiListPlugin = ViewPlugin.fromClass(
  EmojiListPlugin,
  pluginSpec
);
```

`buildDecorations()`ëŠ” ì—ë””í„° ë·°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì™„ì „í•œ ë°ì½”ë ˆì´ì…˜ ì„¸íŠ¸ë¥¼ êµ¬ì„±í•˜ëŠ” ë„ìš°ë¯¸ ë©”ì„œë“œì…ë‹ˆë‹¤.

`ViewPlugin.fromClass()` í•¨ìˆ˜ì˜ ë‘ ë²ˆì§¸ ì¸ìˆ˜ì— ì£¼ëª©í•˜ì„¸ìš”. `PluginSpec`ì˜ `decorations` ì†ì„±ì€ ë·° í”ŒëŸ¬ê·¸ì¸ì´ ë°ì½”ë ˆì´ì…˜ì„ ì—ë””í„°ì— ì œê³µí•˜ëŠ” ë°©ë²•ì„ ì§€ì •í•©ë‹ˆë‹¤.

ë·° í”ŒëŸ¬ê·¸ì¸ì€ ì‚¬ìš©ìì—ê²Œ ë³´ì´ëŠ” ë‚´ìš©ì„ ì•Œê³  ìˆìœ¼ë¯€ë¡œ `view.visibleRanges`ë¥¼ ì‚¬ìš©í•˜ì—¬ êµ¬ë¬¸ íŠ¸ë¦¬ì—ì„œ ë°©ë¬¸í•  ë¶€ë¶„ì„ ì œí•œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
